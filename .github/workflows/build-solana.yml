name: Build and Deploy Solana Programs

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'house.fun/programs/**'
      - 'house.fun/Anchor.toml'
      - 'house.fun/Cargo.toml'
      - 'house.fun/Cargo.lock'
  workflow_dispatch:

env:
  SOLANA_VERSION: "1.18.17"
  ANCHOR_VERSION: "0.30.1"
  RUST_TOOLCHAIN: "1.77.0"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ─── Rust Toolchain ───────────────────────────────────────────────
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.77.0"
          components: rustfmt, clippy

      - name: Cache Cargo Registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
          key: cargo-${{ runner.os }}-${{ env.RUST_TOOLCHAIN }}-${{ hashFiles('house.fun/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-${{ env.RUST_TOOLCHAIN }}-

      # ─── Solana CLI ───────────────────────────────────────────────────
      # Uses release.anza.xyz (new official URL after Anza/Agave rebrand).
      # Retries 3 times to handle transient SSL/network errors.
      - name: Cache Solana CLI
        id: cache-solana
        uses: actions/cache@v4
        with:
          path: ~/.local/share/solana
          key: solana-${{ runner.os }}-v${{ env.SOLANA_VERSION }}

      - name: Install Solana CLI
        if: steps.cache-solana.outputs.cache-hit != 'true'
        run: |
          for i in 1 2 3; do
            echo "Attempt $i: Installing Solana CLI v${{ env.SOLANA_VERSION }}..."
            if sh -c "$(curl -sSfL https://release.anza.xyz/v${{ env.SOLANA_VERSION }}/install)"; then
              echo "Solana CLI installed successfully"
              break
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
            if [ $i -eq 3 ]; then
              echo "All 3 attempts failed"
              exit 1
            fi
          done

      - name: Add Solana to PATH
        run: echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      # ─── Anchor CLI ───────────────────────────────────────────────────
      - name: Cache Anchor CLI
        id: cache-anchor
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/anchor
          key: anchor-${{ runner.os }}-v${{ env.ANCHOR_VERSION }}

      - name: Install Anchor CLI
        if: steps.cache-anchor.outputs.cache-hit != 'true'
        run: |
          cargo install --git https://github.com/coral-xyz/anchor \
            --tag v${{ env.ANCHOR_VERSION }} \
            anchor-cli \
            --locked \
            --force

      # ─── Node.js ──────────────────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ─── Verify Tools ─────────────────────────────────────────────────
      - name: Verify Tool Versions
        run: |
          solana --version
          anchor --version
          rustc --version
          node --version

      # ─── Wallet Setup ─────────────────────────────────────────────────
      - name: Setup Deployer Wallet
        run: |
          cd house.fun
          node -e "
            try {
              let key = process.env.SECRET.trim();
              if (key.startsWith('\"') && key.endsWith('\"')) key = key.slice(1, -1);
              const array = JSON.parse(key);
              if (!Array.isArray(array) || array.length !== 64) {
                throw new Error('Expected 64-byte array, got length: ' + array.length);
              }
              require('fs').writeFileSync('deployer-key.json', JSON.stringify(array));
              console.log('Deployer keypair written (64 bytes)');
            } catch (e) {
              console.error('Error parsing DEVNET_DEPLOYER_KEYPAIR: ' + e.message);
              process.exit(1);
            }
          "
          solana config set --url devnet
          solana config set --keypair deployer-key.json
          echo "Deployer: $(solana address)"
          echo "Balance:  $(solana balance)"
        env:
          SECRET: ${{ secrets.DEPLOYER_KEY }}

      # ─── Fix Cargo.lock Compatibility ────────────────────────────────
      # cargo-build-sbf in Solana 1.18.17 uses rustc 1.75.0-dev.
      # Several transitive deps in the lockfile require newer Rust:
      #   borsh-derive 1.6.0      → needs rustc 1.77.0
      #   proc-macro-crate 3.4.0  → toml_edit 0.23.x → toml_parser (needs 1.76+)
      # Fix: downgrade both + fix lockfile version header.
      - name: Fix Cargo.lock Compatibility for Solana 1.18.17
        run: |
          # Step 1: Downgrade lockfile version header v4 → v3
          find house.fun -name "Cargo.lock" -exec sed -i 's/^version = 4$/version = 3/' {} \;

          # Step 2: Downgrade incompatible deps in each program lockfile
          for dir in house.fun/programs/shadow-poker house.fun/programs/degen-derby house.fun/programs/fight-club; do
            if [ -f "$dir/Cargo.lock" ]; then
              echo "=== Patching $dir ==="
              cd "$dir"
              # Use versioned specs to avoid "multiple packages" ambiguity
              # borsh-derive 1.6.0 requires rustc 1.77.0 → downgrade to 1.5.6
              cargo update "borsh-derive@1.6.0" --precise 1.5.6 2>&1 || echo "borsh-derive update skipped"
              # proc-macro-crate 3.4.0 → toml_edit 0.23.x → toml_parser (needs 1.76+)
              # proc-macro-crate 3.2.0 uses toml_edit 0.22.x (no toml_parser)
              cargo update "proc-macro-crate@3.4.0" --precise 3.2.0 2>&1 || echo "proc-macro-crate update skipped"
              cd - > /dev/null
            fi
          done

          echo "=== Lockfile state after patch ==="
          find house.fun -name "Cargo.lock" -exec head -4 {} \; -print

      # ─── Build ────────────────────────────────────────────────────────
      - name: Build All Programs
        run: |
          cd house.fun
          anchor build

      # ─── Upload Artifacts ─────────────────────────────────────────────
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: solana-program-builds
          path: |
            house.fun/target/deploy/*.so
            house.fun/target/idl/*.json
          retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    # Deploy on manual trigger or push to main
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cache Solana CLI
        id: cache-solana
        uses: actions/cache@v4
        with:
          path: ~/.local/share/solana
          key: solana-${{ runner.os }}-v${{ env.SOLANA_VERSION }}

      - name: Install Solana CLI (if not cached)
        if: steps.cache-solana.outputs.cache-hit != 'true'
        run: |
          for i in 1 2 3; do
            echo "Attempt $i: Installing Solana CLI v${{ env.SOLANA_VERSION }}..."
            if sh -c "$(curl -sSfL https://release.anza.xyz/v${{ env.SOLANA_VERSION }}/install)"; then
              break
            fi
            sleep 10
            [ $i -eq 3 ] && exit 1
          done

      - name: Add Solana to PATH
        run: echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Cache Anchor CLI
        id: cache-anchor
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/anchor
          key: anchor-${{ runner.os }}-v${{ env.ANCHOR_VERSION }}

      - name: Install Anchor CLI (if not cached)
        if: steps.cache-anchor.outputs.cache-hit != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.77.0"

      - name: Install Anchor (cargo)
        if: steps.cache-anchor.outputs.cache-hit != 'true'
        run: |
          cargo install --git https://github.com/coral-xyz/anchor \
            --tag v${{ env.ANCHOR_VERSION }} \
            anchor-cli \
            --locked \
            --force

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: solana-program-builds
          path: house.fun/target/deploy/

      - name: Setup Deployer Wallet
        run: |
          cd house.fun
          node -e "
            try {
              let key = process.env.SECRET.trim();
              if (key.startsWith('\"') && key.endsWith('\"')) key = key.slice(1, -1);
              const array = JSON.parse(key);
              if (!Array.isArray(array) || array.length !== 64) {
                throw new Error('Expected 64-byte array, got length: ' + array.length);
              }
              require('fs').writeFileSync('deployer-key.json', JSON.stringify(array));
              console.log('Deployer keypair written (64 bytes)');
            } catch (e) {
              console.error('Error: ' + e.message);
              process.exit(1);
            }
          "
          RPC_URL="${{ secrets.HELIUS_RPC_URL }}"
          if [ -z "$RPC_URL" ]; then
            RPC_URL="https://api.devnet.solana.com"
            echo "Using public devnet RPC"
          fi
          solana config set --url "$RPC_URL"
          solana config set --keypair deployer-key.json
          echo "Deployer: $(solana address)"
          echo "Balance:  $(solana balance)"
        env:
          SECRET: ${{ secrets.DEPLOYER_KEY }}

      - name: Deploy Shadow Poker
        run: |
          cd house.fun
          anchor deploy \
            --provider.cluster devnet \
            --provider.wallet deployer-key.json \
            --program-name shadow_poker

      - name: Deploy Degen Derby
        run: |
          cd house.fun
          anchor deploy \
            --provider.cluster devnet \
            --provider.wallet deployer-key.json \
            --program-name degen_derby

      - name: Deploy Fight Club
        run: |
          cd house.fun
          anchor deploy \
            --provider.cluster devnet \
            --provider.wallet deployer-key.json \
            --program-name fight_club

      - name: Verify Deployments On-Chain
        run: |
          echo "=== Shadow Poker ==="
          solana program show 3mQcoeWan1JqBJRp6717NR7U8U87fujG2AjB4Pu8vu2s --url devnet || true
          echo "=== Degen Derby ==="
          solana program show Dky8DpKsA4LgCMs1YFUPhrvYE1C1FbwZeFjHSHzXzpzv --url devnet || true
          echo "=== Fight Club ==="
          solana program show GpFdMHcrcFusgR6JMnQVakfQvrXioEw3RJGrMFkBu7nW --url devnet || true

      - name: Upload Final IDLs
        uses: actions/upload-artifact@v4
        with:
          name: deployed-idls
          path: house.fun/target/idl/*.json
          retention-days: 30
