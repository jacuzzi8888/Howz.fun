name: Initialize House Account

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to initialize'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet

jobs:
  initialize-house:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install @coral-xyz/anchor@0.30.1 @solana/web3.js@1.95.3

      - name: Initialize House Account
        env:
          DEPLOYER_KEY: ${{ secrets.DEPLOYER_KEY }}
          RPC_URL: ${{ secrets.HELIUS_RPC_URL }}
        run: |
          node << 'SCRIPT'
          const anchor = require("@coral-xyz/anchor");
          const { Connection, Keypair, PublicKey, SystemProgram } = require("@solana/web3.js");

          const PROGRAM_ID = new PublicKey("6rTzxEePi1mtqs1XXp5ao8Bk6iSXQzzbSayfCk3tdRKQ");
          const RPC_URL = process.env.RPC_URL || "https://api.devnet.solana.com";

          // Embedded IDL - no on-chain fetch or local file needed
          const IDL = {
            "version": "0.1.0",
            "name": "flip_it",
            "instructions": [
              {
                "name": "initializeHouse",
                "accounts": [
                  { "name": "house", "isMut": true, "isSigner": false },
                  { "name": "authority", "isMut": true, "isSigner": true },
                  { "name": "systemProgram", "isMut": false, "isSigner": false }
                ],
                "args": []
              }
            ],
            "accounts": [
              {
                "name": "House",
                "type": {
                  "kind": "struct",
                  "fields": [
                    { "name": "authority", "type": "publicKey" },
                    { "name": "treasury", "type": "u64" },
                    { "name": "totalBets", "type": "u64" },
                    { "name": "totalVolume", "type": "u64" },
                    { "name": "bump", "type": "u8" }
                  ]
                }
              }
            ]
          };

          async function main() {
            console.log("üè† Initializing House Account...\n");

            // Setup connection
            const connection = new Connection(RPC_URL, "confirmed");
            console.log("Connected to:", RPC_URL.replace(/api-key=.*/, "api-key=***"));

            // Load deployer wallet from secret
            const deployerKey = JSON.parse(process.env.DEPLOYER_KEY);
            const wallet = Keypair.fromSecretKey(new Uint8Array(deployerKey));
            console.log("Wallet:", wallet.publicKey.toString());

            // Check balance
            const balance = await connection.getBalance(wallet.publicKey);
            console.log("Balance:", balance / 1e9, "SOL");

            if (balance < 0.005 * 1e9) {
              throw new Error("Insufficient balance. Need at least 0.005 SOL. Get devnet SOL: https://faucet.solana.com/");
            }

            // Derive House PDA
            const [housePDA] = PublicKey.findProgramAddressSync(
              [Buffer.from("house")],
              PROGRAM_ID
            );
            console.log("House PDA:", housePDA.toString());

            // Check if already initialized
            const existing = await connection.getAccountInfo(housePDA);
            if (existing) {
              console.log("\n‚úÖ House account already initialized!");
              console.log("   Address:", housePDA.toString());
              console.log("   Data length:", existing.data.length, "bytes");
              return;
            }

            console.log("House account does not exist. Creating...");

            // Setup anchor wallet & provider
            const anchorWallet = {
              publicKey: wallet.publicKey,
              signTransaction: async (tx) => { tx.partialSign(wallet); return tx; },
              signAllTransactions: async (txs) => { txs.forEach(tx => tx.partialSign(wallet)); return txs; },
            };
            const provider = new anchor.AnchorProvider(connection, anchorWallet, { commitment: "confirmed" });
            const program = new anchor.Program(IDL, PROGRAM_ID, provider);

            // Send initialize transaction
            console.log("\nüìù Sending initializeHouse transaction...");
            const tx = await program.methods
              .initializeHouse()
              .accounts({
                house: housePDA,
                authority: wallet.publicKey,
                systemProgram: SystemProgram.programId,
              })
              .rpc();

            console.log("\n‚úÖ House initialized successfully!");
            console.log("   Transaction:", tx);
            console.log("   House PDA:", housePDA.toString());
            console.log("   Explorer: https://explorer.solana.com/tx/" + tx + "?cluster=devnet");
          }

          main().catch(err => { console.error("‚ùå Error:", err.message || err); process.exit(1); });
          SCRIPT

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "  HOUSE INITIALIZATION COMPLETE"
          echo "=========================================="
          echo ""
          echo "Program ID: 6rTzxEePi1mtqs1XXp5ao8Bk6iSXQzzbSayfCk3tdRKQ"
          echo "Network:    ${{ github.event.inputs.environment }}"
          echo ""
          echo "House is ready for betting!"
