name: Initialize House Account

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to initialize'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet

env:
  SOLANA_CLI_VERSION: 1.18.26
  ANCHOR_VERSION: 0.30.1
  NODE_VERSION: 20
  RPC_URL: ${{ secrets.HELIUS_RPC_URL }}

jobs:
  initialize-house:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: house.fun/house-fun-app/package-lock.json

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_CLI_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version

      - name: Setup Deployer Wallet
        run: |
          mkdir -p ~/.config/solana
          echo "${{ secrets.DEPLOYER_KEY }}" > ~/.config/solana/id.json
          chmod 600 ~/.config/solana/id.json
          solana config set --keypair ~/.config/solana/id.json
          solana config set --url ${{ env.RPC_URL }}
          echo "Wallet pubkey: $(solana-keygen pubkey ~/.config/solana/id.json)"

      - name: Check Wallet Balance
        run: |
          BALANCE=$(solana balance | awk '{print $1}')
          echo "Wallet balance: $BALANCE SOL"
          if (( $(echo "$BALANCE < 0.01" | bc -l) )); then
            echo "âŒ ERROR: Insufficient balance. Need at least 0.01 SOL."
            echo "Get devnet SOL from: https://faucet.solana.com/"
            exit 1
          fi

      - name: Install Anchor
        run: |
          npm install -g @coral-xyz/anchor-cli@${{ env.ANCHOR_VERSION }}
          anchor --version

      - name: Install dependencies
        working-directory: house.fun/programs/flip-it
        run: npm install

      - name: Build Program
        working-directory: house.fun/programs/flip-it
        run: anchor build

      - name: Initialize House Account
        working-directory: house.fun/programs/flip-it
        run: |
          echo "ğŸ  Initializing House Account..."
          
          # Get program ID
          PROGRAM_ID="6rTzxEePi1mtqs1XXp5ao8Bk6iSXQzzbSayfCk3tdRKQ"
          echo "Program ID: $PROGRAM_ID"
          
          # Calculate House PDA
          HOUSE_PDA=$(solana-keygen pubkey --program-id "$PROGRAM_ID" --with-seed "house" | head -1)
          echo "House PDA: $HOUSE_PDA"
          
          # Check if house already exists
          ACCOUNT_INFO=$(solana account "$HOUSE_PDA" 2>&1 || true)
          if echo "$ACCOUNT_INFO" | grep -q "Error"; then
            echo "âœ“ House account does not exist yet. Creating..."
          else
            echo "âœ… House account already initialized!"
            echo "$ACCOUNT_INFO"
            exit 0
          fi
          
          # Run initialization script
          node scripts/initialize-house.js 2>&1 || {
            echo "âŒ Initialization failed"
            exit 1
          }

      - name: Verify House Account
        run: |
          PROGRAM_ID="6rTzxEePi1mtqs1XXp5ao8Bk6iSXQzzbSayfCk3tdRKQ"
          HOUSE_PDA=$(solana-keygen pubkey --program-id "$PROGRAM_ID" --with-seed "house" | head -1)
          
          echo ""
          echo "ğŸ” Verifying House Account..."
          echo "House PDA: $HOUSE_PDA"
          
          solana account "$HOUSE_PDA"

      - name: Deployment Summary
        run: |
          PROGRAM_ID="6rTzxEePi1mtqs1XXp5ao8Bk6iSXQzzbSayfCk3tdRKQ"
          HOUSE_PDA=$(solana-keygen pubkey --program-id "$PROGRAM_ID" --with-seed "house" | head -1)
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘         ğŸ  HOUSE INITIALIZATION COMPLETE! ğŸ           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Program ID: $PROGRAM_ID"
          echo "House PDA:  $HOUSE_PDA"
          echo "Network:    ${{ github.event.inputs.environment }}"
          echo ""
          echo "Links:"
          echo "  â€¢ Program: https://explorer.solana.com/address/$PROGRAM_ID?cluster=devnet"
          echo "  â€¢ House:   https://explorer.solana.com/address/$HOUSE_PDA?cluster=devnet"
          echo ""
          echo "âœ… House is ready for betting!"
