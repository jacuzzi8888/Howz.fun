name: Initialize House Account

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to initialize'
        required: true
        default: 'devnet'
        type: choice
        options:
          - devnet
          - mainnet

jobs:
  initialize-house:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install @coral-xyz/anchor@0.30.1 @solana/web3.js@1.95.3

      - name: Initialize House Account
        env:
          DEPLOYER_KEY: ${{ secrets.DEPLOYER_KEY }}
          RPC_URL: ${{ secrets.HELIUS_RPC_URL }}
        run: |
          node << 'SCRIPT'
          const anchor = require("@coral-xyz/anchor");
          const { Connection, Keypair, PublicKey, SystemProgram, Transaction, TransactionInstruction } = require("@solana/web3.js");

          const PROGRAM_ID = new PublicKey("6rTzxEePi1mtqs1XXp5ao8Bk6iSXQzzbSayfCk3tdRKQ");
          const RPC_URL = process.env.RPC_URL || "https://api.devnet.solana.com";

          // Discriminator for initializeHouse (first 8 bytes of sha256("global:initialize_house"))
          const INITIALIZE_HOUSE_DISCRIMINATOR = Buffer.from([112, 146, 238, 68, 186, 143, 197, 129]);

          async function main() {
            console.log("üè† Initializing House Account...\n");

            // Setup connection
            const connection = new Connection(RPC_URL, "confirmed");
            console.log("Connected to:", RPC_URL.replace(/api-key=.*/, "api-key=***"));

            // Load deployer wallet from secret
            if (!process.env.DEPLOYER_KEY) {
              throw new Error("DEPLOYER_KEY secret not set");
            }
            const deployerKey = JSON.parse(process.env.DEPLOYER_KEY);
            const wallet = Keypair.fromSecretKey(new Uint8Array(deployerKey));
            console.log("Wallet:", wallet.publicKey.toString());

            // Check balance
            const balance = await connection.getBalance(wallet.publicKey);
            console.log("Balance:", balance / 1e9, "SOL");

            if (balance < 0.005 * 1e9) {
              throw new Error("Insufficient balance. Need at least 0.005 SOL. Get devnet SOL: https://faucet.solana.com/");
            }

            // Derive House PDA
            const [housePDA, houseBump] = PublicKey.findProgramAddressSync(
              [Buffer.from("house")],
              PROGRAM_ID
            );
            console.log("House PDA:", housePDA.toString());
            console.log("House Bump:", houseBump);

            // Check if already initialized
            const existing = await connection.getAccountInfo(housePDA);
            if (existing) {
              console.log("\n‚úÖ House account already initialized!");
              console.log("   Address:", housePDA.toString());
              console.log("   Data length:", existing.data.length, "bytes");
              return;
            }

            console.log("House account does not exist. Creating...");

            // Build instruction manually to avoid Anchor serialization issues
            const keys = [
              { pubkey: housePDA, isSigner: false, isWritable: true },
              { pubkey: wallet.publicKey, isSigner: true, isWritable: true },
              { pubkey: SystemProgram.programId, isSigner: false, isWritable: false },
            ];

            const instruction = new TransactionInstruction({
              keys,
              programId: PROGRAM_ID,
              data: INITIALIZE_HOUSE_DISCRIMINATOR,
            });

            // Build and send transaction
            console.log("\nüìù Sending initializeHouse transaction...");
            
            const transaction = new Transaction().add(instruction);
            transaction.feePayer = wallet.publicKey;
            
            const { blockhash } = await connection.getLatestBlockhash();
            transaction.recentBlockhash = blockhash;
            
            transaction.sign(wallet);
            
            const signature = await connection.sendRawTransaction(transaction.serialize());
            console.log("Transaction sent:", signature);
            
            // Wait for confirmation
            const confirmation = await connection.confirmTransaction(signature, "confirmed");
            
            if (confirmation.value.err) {
              throw new Error("Transaction failed: " + JSON.stringify(confirmation.value.err));
            }

            console.log("\n‚úÖ House initialized successfully!");
            console.log("   Transaction:", signature);
            console.log("   House PDA:", housePDA.toString());
            console.log("   Explorer: https://explorer.solana.com/tx/" + signature + "?cluster=devnet");
          }

          main().catch(err => { 
            console.error("‚ùå Error:", err.message || err); 
            if (err.logs) console.error("Logs:", err.logs);
            process.exit(1); 
          });
          SCRIPT

      - name: Summary
        if: success()
        run: |
          echo ""
          echo "=========================================="
          echo "  HOUSE INITIALIZATION COMPLETE"
          echo "=========================================="
          echo ""
          echo "Program ID: 6rTzxEePi1mtqs1XXp5ao8Bk6iSXQzzbSayfCk3tdRKQ"
          echo "Network:    ${{ github.event.inputs.environment }}"
          echo ""
          echo "House is ready for betting!"
